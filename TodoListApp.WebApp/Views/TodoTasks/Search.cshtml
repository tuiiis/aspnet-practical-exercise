@model IEnumerable<TodoListApp.WebApp.Models.TodoTask>
@using TodoListApp.WebApp.Models

@{
    ViewData["Title"] = "Search Tasks";
    var searchTerm = ViewData["SearchTerm"] as string ?? "";
    var selectedTagIds = ViewData["SelectedTagIds"] as int[] ?? Array.Empty<int>();
    var allTags = ViewData["AllTags"] as IEnumerable<Tag> ?? Enumerable.Empty<Tag>();
}

<h2>@ViewData["Title"]</h2>

<div class="row mb-3">
    <div class="col-md-12">
        <form method="get" asp-action="Search" id="searchForm">
            <div class="mb-3">
                <label for="searchTerm" class="form-label">Search by Title:</label>
                <div class="d-flex gap-2">
                    <input type="text" name="searchTerm" id="searchTerm" class="form-control" value="@searchTerm" placeholder="Enter search term..." />
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Filter by Tags:</label>
                <div class="d-flex flex-wrap gap-2" id="tagFilterContainer">
                    @foreach (var tag in allTags)
                    {
                        var isSelected = selectedTagIds.Contains(tag.Id);
                        <button type="button" 
                                class="tag-filter-btn @(isSelected ? "tag-filter-selected" : "")" 
                                data-tag-id="@tag.Id"
                                onclick="toggleTag(@tag.Id)">
                            @tag.Name
                        </button>
                    }
                </div>
                @if (!allTags.Any())
                {
                    <p class="text-muted small">No tags available. Create tasks with tags to filter by them.</p>
                }
            </div>
            <div id="tagInputs">
                @foreach (var tagId in selectedTagIds)
                {
                    <input type="hidden" name="tagIds" value="@tagId" />
                }
            </div>
        </form>
    </div>
</div>

@if (!string.IsNullOrEmpty(searchTerm) || (selectedTagIds != null && selectedTagIds.Length > 0))
{
    @if (!Model.Any())
    {
        <p class="text-muted">No tasks found matching your search criteria.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th class="table-col-title">
                        Task
                    </th>
                    <th class="table-col-status">
                        Status
                    </th>
                    <th class="table-col-due-date">
                        Due Date
                    </th>
                    <th class="table-col-tags">
                        Tags
                    </th>
                    <th>
                        List
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var isOverdue = item.DueDate.HasValue && item.DueDate.Value < DateTime.UtcNow && item.Status != TodoListApp.WebApp.Models.TaskStatus.Completed;
                    var rowClass = isOverdue ? "table-danger" : "";
                    
                    <tr class="@rowClass clickable-row" data-href="@Url.Action("Details", "TodoTasks", new { id = item.Id })">
                        <td class="table-col-title table-cell-overflow">
                            @Html.DisplayFor(modelItem => item.Title)
                            @if (isOverdue)
                            {
                                <span class="badge bg-danger ms-2">Overdue</span>
                            }
                        </td>
                        <td class="table-col-status">
                            @Html.DisplayFor(modelItem => item.Status)
                        </td>
                        <td class="table-col-due-date">
                            @if (item.DueDate.HasValue)
                            {
                                @item.DueDate.Value.ToLocalTime().ToString("MM/dd/yyyy")
                            }
                        </td>
                        <td class="table-col-tags">
                            @if (item.Tags != null && item.Tags.Any())
                            {
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var tag in item.Tags)
                                    {
                                        <a href="@Url.Action("TasksByTag", "Tags", new { id = tag.Id })" class="tag-badge" onclick="event.stopPropagation();">@tag.Name</a>
                                    }
                                </div>
                            }
                            else
                            {
                                <span class="text-muted">No tags</span>
                            }
                        </td>
                        <td>
                            @if (item.TodoList != null)
                            {
                                <a href="@Url.Action("Index", "TodoTasks", new { todoListId = item.TodoList.Id })" onclick="event.stopPropagation();">@item.TodoList.Title</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@section Scripts {
    <script>
        let selectedTags = new Set(@Html.Raw(Json.Serialize(selectedTagIds)));

        function toggleTag(tagId) {
            const btn = document.querySelector(`[data-tag-id="${tagId}"]`);
            if (selectedTags.has(tagId)) {
                selectedTags.delete(tagId);
                btn.classList.remove('tag-filter-selected');
            } else {
                selectedTags.add(tagId);
                btn.classList.add('tag-filter-selected');
            }
            updateTagInputs();
            // Auto-submit form when tags are toggled
            document.getElementById('searchForm').submit();
        }

        function updateTagInputs() {
            const container = document.getElementById('tagInputs');
            container.innerHTML = '';
            selectedTags.forEach(tagId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'tagIds';
                input.value = tagId;
                container.appendChild(input);
            });
        }

    </script>
}

